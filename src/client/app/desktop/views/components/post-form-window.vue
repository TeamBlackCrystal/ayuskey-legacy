<template>
<mk-window ref="window" class="mk-post-form-window" is-modal :animation="animation" @closed="onWindowClosed">
	<template #header>
		<span class="mk-post-form-window--header">
			<span v-if="geo" class="icon"><fa icon="map-marker-alt"/></span>
			<span v-if="!reply">{{ $t('note') }}</span>
			<span v-if="reply">{{ $t('reply') }}</span>
			<span v-if="files.length != 0" class="count">{{ $t('attaches').replace('{}', files.length) }}</span>
			<span v-if="uploadings.length != 0" class="count">{{ $t('uploading-media').replace('{}', uploadings.length) }}<mk-ellipsis/></span>
		</span>
	</template>

	<div class="mk-post-form-window--body" :style="{ maxHeight: `${maxHeight}px` }">
		<mk-note-preview v-if="reply" class="notePreview" :note="reply"/>
		<x-post-form
			ref="form"
			:reply="reply"
			:air-reply="airReply"
			:mention="mention"
			:initial-text="initialText"
			:initial-note="initialNote"
			:instant="instant"

			@posted="onPosted"
			@change-uploadings="onChangeUploadings"
			@change-attached-files="onChangeFiles"
			@geo-attached="onGeoAttached"
			@geo-dettached="onGeoDettached"/>
	</div>
</mk-window>
</template>

<script lang="ts">
import { defineComponent } from 'vue';
import i18n from '../../../i18n';
import XPostForm from './post-form.vue';

export default defineComponent({
	i18n: i18n('desktop/views/components/post-form-window.vue'),

	components: {
		XPostForm,
	},

	props: {
		reply: {
			type: Object,
			required: false,
		},
		airReply: {
			type: Object,
			required: false,
		},
		mention: {
			type: Object,
			required: false,
		},

		animation: {
			type: Boolean,
			required: false,
			default: true,
		},

		initialText: {
			type: String,
			required: false,
		},

		initialNote: {
			type: Object,
			required: false,
		},

		instant: {
			type: Boolean,
			required: false,
			default: false,
		},
	},

	data() {
		return {
			uploadings: [],
			files: [],
			geo: null,
		};
	},

	computed: {
		maxHeight() {
			return window.innerHeight - 50;
		},
	},

	mounted() {
		this.$nextTick(() => {
			(this.$refs.form as any).focus();
		});
	},

	methods: {
		onChangeUploadings(files) {
			this.uploadings = files;
		},
		onChangeFiles(files) {
			this.files = files;
		},
		onGeoAttached(geo) {
			this.geo = geo;
		},
		onGeoDettached() {
			this.geo = null;
		},
		onPosted() {
			(this.$refs.window as any).close();
		},
		onWindowClosed() {
			this.$emit('closed');
			this.destroyDom();
		},
	},
});
</script>

<style lang="stylus" scoped>
.mk-post-form-window
	.mk-post-form-window--header
		.icon
			margin-right 8px

		.count
			margin-left 8px
			opacity 0.8

			&:before
				content '('

			&:after
				content ')'

	.mk-post-form-window--body
		.notePreview
				max-width 540px
				margin 16px 22px

</style>
