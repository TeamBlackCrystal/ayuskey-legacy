<template>
<x-column>
	<template #header>
		<fa icon="user"/><mk-user-name v-if="user" :key="user.id" :user="user"/>
	</template>

	<div v-if="user" class="zubukjlciycdsyynicqrnlsmdwmymzqu">
		<div v-if="user.host != null" class="is-remote">
			<details>
				<summary><fa icon="exclamation-triangle"/> {{ $t('@.is-remote-user') }}</summary>
				<a :href="user.url" rel="nofollow noopener" target="_blank">{{ $t('@.view-on-remote') }}</a>
			</details>
		</div>
		<header :style="bannerStyle">
			<div>
				<button ref="menu" class="menu" @click="menu"><fa icon="ellipsis-h"/></button>
				<mk-follow-button v-if="$store.getters.isSignedIn && user.id != $store.state.i.id" :user="user" class="follow" mini/>
				<mk-avatar :key="user.id" class="avatar" :user="user" :disable-preview="true"/>
				<router-link class="name" :to="userPage(user)">
					<mk-user-name :key="user.id" :user="user" :nowrap="false"/>
				</router-link>
				<span class="acct">@{{ acct(user) }} <fa v-if="user.isLocked == true" class="locked" icon="lock" fixed-width/></span>
				<span v-if="user.movedToUser != null" class="moved">Moved to <router-link :to="userPage(user.movedToUser)"><mk-acct :user="user.movedToUser" :detail="true"/></router-link></span>
				<span v-if="user.isFollowed" class="followed">{{ $t('follows-you') }}</span>
			</div>
		</header>
		<div class="info">
			<div class="description">
				<mfm v-if="user.description" :key="user.id" :text="user.description" :is-note="false" :author="user" :i="$store.state.i" :custom-emojis="user.emojis"/>
			</div>
			<div v-if="user.fields" :key="user.id" class="fields">
				<dl v-for="(field, i) in user.fields" :key="i" class="field">
					<dt class="name">
						<mfm :text="field.name" :plain="true" :custom-emojis="user.emojis"/>
					</dt>
					<dd class="value">
						<mfm :text="field.value" :author="user" :i="$store.state.i" :custom-emojis="user.emojis"/>
					</dd>
				</dl>
			</div>
			<div class="counts">
				<div>
					<router-link :to="userPage(user)">
						<b>{{ number(user.notesCount) }}</b>
						<span>{{ $t('posts') }}</span>
					</router-link>
				</div>
				<div>
					<router-link :to="userPage(user, 'following')">
						<b>{{ number(user.followingCount) }}</b>
						<span>{{ $t('following') }}</span>
					</router-link>
				</div>
				<div>
					<router-link :to="userPage(user, 'followers')">
						<b>{{ number(user.followersCount) }}</b>
						<span>{{ $t('followers') }}</span>
					</router-link>
				</div>
			</div>
		</div>
		<router-view :user="user"></router-view>
	</div>
</x-column>
</template>

<script lang="ts">
import { defineComponent } from 'vue';
import i18n from '../../../i18n';
import parseAcct from '../../../../../misc/acct/parse';
import XColumn from './deck.column.vue';
import XUserMenu from '../../../common/views/components/user-menu.vue';
import number from '../filters/v12/number';
import { acct, userPage } from '../filters/v12/user';

export default defineComponent({
	i18n: i18n('deck/deck.user-column.vue'),
	components: {
		XColumn,
	},

	data() {
		return {
			user: null,
			fetching: true,
		};
	},

	computed: {
		bannerStyle(): any {
			if (this.user == null) return {};
			if (this.user.bannerUrl == null) return {};
			return {
				backgroundColor: this.user.bannerColor,
				backgroundImage: `url(${ this.user.bannerUrl })`,
			};
		},
	},

	watch: {
		$route: 'fetch',
	},

	created() {
		this.fetch();
	},

	methods: {
		fetch() {
			this.fetching = true;
			this.$root.api('users/show', parseAcct(this.$route.params.user)).then(user => {
				this.user = user;
				this.fetching = false;
			});
		},

		menu() {
			const w = this.$root.new(XUserMenu, {
				source: this.$refs.menu,
				user: this.user,
			});
			this.$once('hook:beforeDestroy', () => {
				w.destroyDom();
			});
		},
		number, acct, userPage,
	},
});
</script>

<style lang="stylus" scoped>
.zubukjlciycdsyynicqrnlsmdwmymzqu
	background var(--deckColumnBg)

	> .is-remote
		padding 8px 16px
		font-size 12px

		&.is-remote
			color var(--remoteInfoFg)
			background var(--remoteInfoBg)

		> a
			font-weight bold

	> header
		overflow hidden
		background-size cover
		background-position center

		> div
			padding 32px
			background rgba(#000, 0.5)
			color #fff
			text-align center

			> .menu
				position absolute
				top 8px
				left 8px
				padding 8px
				font-size 16px
				text-shadow 0 0 8px #000

			> .follow
				position absolute
				top 16px
				right 16px

			> .avatar
				display block
				width 64px
				height 64px
				margin 0 auto

			> .name
				display block
				margin-top 8px
				font-weight bold
				text-shadow 0 0 8px #000
				color #fff

			> .acct, .moved
				display block
				font-size 14px
				opacity 0.7
				text-shadow 0 0 8px #000

				> .locked
					opacity 0.8

			> .followed
				display inline-block
				font-size 12px
				background rgba(0, 0, 0, 0.5)
				opacity 0.7
				margin-top: 2px
				padding 4px
				border-radius 4px

	> .info
		padding 16px
		font-size 12px
		color var(--text)
		text-align center
		background var(--face)

		&:before
			content ""
			display blcok
			position absolute
			top -32px
			left 0
			right 0
			width 0
			margin 0 auto
			border-top solid 16px transparent
			border-left solid 16px transparent
			border-right solid 16px transparent
			border-bottom solid 16px var(--face)

		> .fields
			margin-top 8px

			> .field
				display flex
				padding 0
				margin 0
				align-items center

				> .name
					padding 4px
					margin 4px
					width 30%
					overflow hidden
					white-space nowrap
					text-overflow ellipsis
					font-weight bold

				> .value
					padding 4px
					margin 4px
					width 70%
					overflow hidden
					white-space nowrap
					text-overflow ellipsis

		> .counts
			display grid
			grid-template-columns 2fr 2fr 2fr
			margin-top 8px
			border-top solid var(--lineWidth) var(--faceDivider)

			> div
				padding 8px 8px 0 8px
				text-align center

				> a
					color var(--text)

					> b
						display block
						font-size 110%

					> span
						display block
						font-size 80%
						opacity 0.7

</style>
